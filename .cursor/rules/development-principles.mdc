---
description: AI News Aggregator プロジェクトの開発原則とコーディング規約
alwaysApply: true
---

# AI News Aggregator プロジェクト - 開発原則

このプロジェクトは Next.js 14 (App Router) + Cloudflare Pages + D1 を使用した AI ニュースアグリゲーターです。
Cursor での開発効率を最大化するための行動指針を定義します。

## 🚨 最優先：思考と判断の原則

**すべての実装前に以下を参照すること**

1. **`project-context.mdc`** - プロジェクトの長期的なコンテキストと制約を理解
2. **`critical-thinking.mdc`** - 意思決定のフレームワークを確認

### 基本的な思考プロセス

エラーや要求に対して、即座に対応するのではなく：

1. **長期的な目的を確認** - このプロジェクトの真の目的は何か？
2. **制約の意図を理解** - この制約は何を守るために存在するのか？
3. **ベストプラクティスを確認** - 一般的な解決方法は何か？
4. **適切な対応を判断** - 総合的に考えて、正しい対応は何か？
5. **実行** - 判断した対応を実行

### 「立ち止まって考える」べきタイミング

以下の場合は、**必ず立ち止まって、長期的なコンテキストを確認すること：**

- エラーが発生したとき（エラーを消すことが目的ではない）
- 環境変数や認証情報を扱うとき（セキュリティは最優先）
- ファイルを削除するとき（影響範囲を確認）
- セキュリティに関わる操作をするとき（権限を緩めることは最後の手段）
- ユーザーの要求が不明確なとき（真の意図を理解）

## 開発原則

### 1. ファイル構造の遵守
- `/app/api/` 配下に API ルートを配置
- `/app/dashboard/` 配下にダッシュボードページを配置
- 各 API ルートは単一責任の原則に従う
- 共通ロジックは `/lib/` または `/utils/` に配置

### 2. TypeScript の使用
- すべてのファイルは TypeScript を使用
- 型定義は明示的に記述
- `any` 型の使用は避ける（やむを得ない場合は `@ts-ignore` とコメントを併記）

### 3. API ルートの設計
- 各 API ルートは独立して動作可能にする
- エラーハンドリングを必ず実装
- レスポンスは統一された形式で返す
- ログ出力を適切に行う（D1 の `logs` テーブルに記録）
- Cloudflare Pages環境では、`request.env`からD1データベースを取得

### 4. Cloudflare D1 との連携
- データベース操作は `lib/db.ts` の `createSupabaseClient()` を使用（Supabase互換API）
- Cloudflare D1はSQLiteベースのサーバーレスデータベース
- すべてのデータベース操作は非同期（`await`が必要）
- マイグレーションは `wrangler d1 migrations apply` コマンドで実行
- ローカル開発時は `wrangler pages dev` を使用

### 5. 外部 API の呼び出し
- レート制限を考慮した実装
- リトライロジックの実装
- タイムアウト設定
- エラー時の適切なフォールバック

### 6. コードスタイル
- ESLint / Prettier の設定に従う
- 関数名は動詞で始める（`fetch-*`, `summarize-*`, `push-*` など）
- コメントは日本語で記述（ビジネスロジックの説明）
- 複雑な処理には JSDoc コメントを追加

### 7. 環境変数の管理
- `.env.local` に機密情報を保存
- `.env.example` に必要な環境変数のリストを記載
- 環境変数の取得は `process.env` を使用し、デフォルト値は適切に設定

### 8. エラーハンドリング
- try-catch ブロックでエラーを捕捉
- エラーログを D1 の `logs` テーブルに記録（非同期操作）
- ユーザー向けエラーメッセージは分かりやすく
- 開発環境では詳細なエラー情報を表示
- D1データベースのbindingが設定されていない場合のエラーハンドリング

### 9. パフォーマンス
- 大量データの取得時はページネーションを実装
- 不要な再レンダリングを避ける（React.memo の適切な使用）
- データベースクエリはインデックスを考慮
- キャッシュを適切に活用（必要に応じて）
- トレンド分析は定期的に実行し、結果を `trends` テーブルに保存（リアルタイム計算を避ける）
- 時系列データの集計時は適切な時間範囲でクエリを分割

### 10. セキュリティ
- API ルートは認証が必要な場合は適切に実装
- SQL インジェクション対策（Supabase のクエリビルダーを使用）
- XSS 対策（サニタイズ処理）
- 環境変数の漏洩に注意

## コーディング規約

### API ルートのテンプレート
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

export async function GET(request: NextRequest) {
  try {
    // 処理を実装
    return NextResponse.json({ success: true, data: result });
  } catch (error) {
    console.error('Error:', error);
    return NextResponse.json({ success: false, error: error.message }, { status: 500 });
  }
}
```

### データベース操作のパターン
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createSupabaseClient } from '@/lib/db';

export async function GET(request: NextRequest) {
  try {
    // Cloudflare Pages環境では、envからD1データベースを取得
    const env = (request as any).env || (globalThis as any).__CF_PAGES_ENV__;
    const db = createSupabaseClient(env);

    // 挿入（非同期）
    const { data, error } = await db.from('table_name').insert({
      column: 'value'
    });

    if (error) throw error;

    // 取得（非同期）
    const { data, error } = await db.from('table_name')
      .select('*')
      .eq('column', 'value')
      .all();

    if (error) throw error;

    return NextResponse.json({ success: true, data });
  } catch (error) {
    console.error('Error:', error);
    return NextResponse.json({ success: false, error: error.message }, { status: 500 });
  }
}
```

### 外部 API 呼び出しのパターン
```typescript
const response = await fetch(url, {
  headers: { 'Authorization': `Bearer ${token}` },
  signal: AbortSignal.timeout(10000), // 10秒タイムアウト
});

if (!response.ok) {
  throw new Error(`API Error: ${response.status}`);
}
```

### トレンド分析のパターン
```typescript
// 過去N日間のデータと比較してトレンドを算出
const calculateTrend = async (days: number = 7) => {
  const now = new Date();
  const pastDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
  
  // 現在の期間と過去の期間のデータを取得
  const env = (request as any).env || (globalThis as any).__CF_PAGES_ENV__;
  const db = createSupabaseClient(env);
  
  const { data: current } = await db
    .from('raw_events')
    .select('*')
    .gte('created_at', pastDate.toISOString())
    .all();
  
  const { data: previous } = await db
    .from('raw_events')
    .select('*')
    .gte('created_at', pastDate.toISOString())
    .lt('created_at', pastDate.toISOString())
    .all();
  
  // 増加率を計算
  const growthRate = ((current.length - previous.length) / previous.length) * 100;
  
  return { growthRate, current, previous };
};
```

### 時系列データの扱い
- 日付/時刻は UTC で統一して保存
- トレンド分析時はタイムゾーンを考慮
- 大量データの集計時はインデックスを活用
- 必要に応じて集計結果をキャッシュ（`trends` テーブルに保存）

## 禁止事項

- ハードコーディングされた認証情報
- 無限ループやメモリリークを引き起こす可能性のあるコード
- エラーハンドリングのない外部 API 呼び出し
- 型安全性を無視した実装
- コメントのない複雑なロジック

## 推奨事項

- 各 API ルートに単体テストを追加（可能な範囲で）
- 定期的なコードレビュー
- ドキュメントの更新（README.md の維持）
- パフォーマンスモニタリング
- ログの定期的な確認

## 開発フロー

1. 機能追加時は、まず API ルートの設計を確認
2. データベーススキーマの変更が必要な場合は、マイグレーションを準備
3. 実装後、ローカル環境でテスト
4. エラーハンドリングとログ出力を確認
5. 必要に応じてドキュメントを更新

## ユーザー作業が必要なタイミングでの指示

**重要**: 実装中にユーザーの作業（環境変数設定、API認証など）が必要な場合は、**必ず明確に指示を出す**こと。

### 指示を出すべきタイミング

1. **環境変数の設定が必要な場合**
   - APIキーや認証情報の取得方法を具体的に説明
   - 設定手順をステップバイステップで提示
   - 設定後の動作確認方法を案内

2. **外部サービスの認証が必要な場合**
   - Google Analytics/Search ConsoleのOAuth設定
   - Twitter/X APIの認証設定
   - 認証フローの説明と必要な手順を提示

3. **データの初期投入が必要な場合**
   - 過去のブログ記事データのインポート
   - 既存データの移行作業

4. **設定変更が必要な場合**
   - Cron設定の変更
   - データベースのマイグレーション

### 指示の形式

実装中にユーザー作業が必要になった場合は、以下の形式で明確に指示を出す：

```
【ユーザー作業が必要です】

以下の作業をお願いします：

1. [具体的な作業内容]
   - [詳細な手順1]
   - [詳細な手順2]

2. [次の作業内容]
   - [詳細な手順]

作業完了後、以下のコマンドで動作確認してください：
[確認コマンド]
```

### 実装方針

- 環境変数が未設定でも動作するようにフォールバックを実装
- 環境変数未設定時は、ログに警告を出力し、ユーザーに設定を促す
- 認証が必要な機能は、認証情報が設定されるまでプレースホルダー動作を実装

## 参考情報

- Next.js 14 App Router: https://nextjs.org/docs/app
- Cloudflare Pages: https://developers.cloudflare.com/pages/
- Cloudflare D1: https://developers.cloudflare.com/d1/
- @cloudflare/next-on-pages: https://github.com/cloudflare/next-on-pages
- TypeScript: https://www.typescriptlang.org/docs/
